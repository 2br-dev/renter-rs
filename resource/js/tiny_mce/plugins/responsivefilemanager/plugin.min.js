tinymce.PluginManager.add("responsivefilemanager", function(e) {
    function n(t) {
        0 === e.settings.external_filemanager_path.toLowerCase().indexOf(t.origin.toLowerCase()) && "responsivefilemanager" === t.data.sender && (tinymce.activee.insertContent(t.data.html), tinymce.activee.windowManager.close(), window.removeEventListener ? window.removeEventListener("message", n, !1) : window.detachEvent("onmessage", n))
    }

    function t() {
        var width = window.innerWidth-20;
        var height = window.innerHeight-40;
        if(width > 1800) width=1800;
        if(height > 1200) height=1200;
        if(width>600){
            var width_reduce = (width - 20) % 138;
            width = width - width_reduce + 10;
        }

        e.focus(true);
        var title="RESPONSIVE FileManager";
        if (typeof e.settings.filemanager_title !== "undefined" && e.settings.filemanager_title) {
            title=e.settings.filemanager_title;
        }
        var akey="key";
        if (typeof e.settings.filemanager_access_key !== "undefined" && e.settings.filemanager_access_key) {
            akey=e.settings.filemanager_access_key;
        }
        var sort_by="";
        if (typeof e.settings.filemanager_sort_by !== "undefined" && e.settings.filemanager_sort_by) {
            sort_by="&sort_by="+e.settings.filemanager_sort_by;
        }
        var descending="false";
        if (typeof e.settings.filemanager_descending !== "undefined" && e.settings.filemanager_descending) {
            descending=e.settings.filemanager_descending;
        }
        var fldr="";
        if (typeof e.settings.filemanager_subfolder !== "undefined" && e.settings.filemanager_subfolder) {
            fldr="&fldr="+e.settings.filemanager_subfolder;
        }
        var crossdomain="";
        if (typeof e.settings.filemanager_crossdomain !== "undefined" && e.settings.filemanager_crossdomain) {
            crossdomain="&crossdomain=1";

            // Add handler for a message from ResponsiveFilemanager
            if(window.addEventListener){
                window.addEventListener('message', responsivefilemanager_onMessage, false);
            } else {
                window.attachEvent('onmessage', responsivefilemanager_onMessage);
            }
        }

        const fileUrl = e.settings.external_filemanager_path+'dialog.php?type=4&descending='+descending+sort_by+fldr+crossdomain+'&lang='+e.settings.language+'&akey='+akey;

        if (tinymce.majorVersion < 5) {
            win = e.windowManager.open({
                title: title,
                file: fileUrl,
                width: width,
                height: height,
                inline: 1,
                resizable: true,
                maximizable: true
            });
        } else {
            win = e.windowManager.openUrl({
                title: title,
                url: fileUrl,
                width: width,
                height: height,
                inline: 1,
                resizable: true,
                maximizable: true
            });
        }
    }
    e.ui.registry.addButton("responsivefilemanager", {
        icon: "browse",
        tooltip: "Вставить изображение",
        shortcut: "Ctrl+E",
        onAction: t
    }),
    e.addShortcut("Ctrl+E", "", t),
    e.ui.registry.addMenuItem("responsivefilemanager", {
        icon: "browse",
        text: "Insert file",
        shortcut: "Ctrl+E",
        onAction: t,
        context: "insert"
    })
});